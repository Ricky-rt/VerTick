/*
 source : nehan.js
 version : 1.0.5.3
 site : http://tategakibunko.mydns.jp/
 blog : http://tategakibunko.blog83.fc2.com/

 Copyright (c) 2010, Watanabe Masaki <lambda.watanabe@gmail.com>
 licenced under MIT licence.

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/


var Nehan;if(!Nehan){Nehan={}}if(!Nehan.Layout){Nehan.Layout={}}if(!Nehan.TextStream){Nehan.TextStream={}}if(!Nehan.StreamParser){Nehan.StreamParser={}}if(!Nehan.LayoutMapper){Nehan.LayoutMapper={}}if(!Nehan.Env){Nehan.Env={}}if(!Nehan.ParserHook){Nehan.ParserHook={}}(function(){var l={concat:function(o,n){o=(o=="")?"":(o.slice(-1)=="/")?o:o+"/";n=(n=="")?"":(n[0]=="/")?n.substring(1,n.length):n;return o+n}};var h={read:function(p,o,n){for(prop in o){p[prop]=(typeof n[prop]=="undefined")?o[prop]:n[prop]}}};var j={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(q){for(var n=0;n<q.length;n++){var o=q[n].string;var p=q[n].prop;this.versionSearchString=q[n].versionSearch||q[n].identity;if(o){if(o.indexOf(q[n].subString)!=-1){return q[n].identity}}else{if(p){return q[n].identity}}}},searchVersion:function(o){var n=o.indexOf(this.versionSearchString);if(n==-1){return}return parseFloat(o.substring(n+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};j.init();var d={init:function(){var o=j.browser.toLowerCase();var n=j.version;var p=j.OS;this.isIE=(o=="explorer");this.isWin=(p=="Windows");this.isMac=(p=="Mac");this.isVistaOrWin7=(navigator.userAgent.toLowerCase().indexOf("windows nt 6")>=0);if(o=="chrome"){this.canTransform=true}else{if(o=="safari"){this.canTransform=true}else{if(o=="firefox"&&n>=3.5){this.canTransform=true}else{if(this.isIE&&!this.isVistaOrWin7&&n>=6){this.canTransform=true}else{this.canTransform=false}}}}}};d.init();function k(n){h.read(this,{width:700,height:480,fontSize:16,lineHeightRate:1.8,letterSpacingRate:0.1,direction:"vertical",textLayerClassName:"text-layer",charImgRoot:"/img/char",charImgMap:[],charImgColor:"black",kinsokuCharCount:2},n);if(typeof n.fontFamily!="undefined"){this.fontFamily=n.fontFamily}this.initialize()}k.prototype.initialize=function(){this.direction=this.direction.toLowerCase();this.directionH=(this.direction=="horizontal"||this.direction=="vertical-lr")?"lr":"rl";this.isV=(this.direction=="vertical"||this.direction=="vertical-lr"||this.direction=="vertical-rl");this.baseLineHeight=Math.floor(this.lineHeightRate*this.fontSize);this.baseLetterSpacing=Math.floor(this.letterSpacingRate*this.fontSize);var n=this.baseLineHeight;var o=this.fontSize+this.baseLetterSpacing;this.width=Math.max(n,this.width);this.height=Math.max(o,this.height);this.yohakuHeight=this.baseLineHeight-this.fontSize;this.letterHeight=(this.isV)?this.fontSize+this.baseLetterSpacing:1;this.wrapTag=(this.isV)?"table":"div";this.rubyFontSize=Math.floor(this.fontSize/2);if(this.isV){this.lineCount=Math.floor(this.height/this.letterHeight)-this.kinsokuCharCount}else{this.lineCount=Math.floor(this.width/this.fontSize)-this.kinsokuCharCount}if(d.isMac&&this.fontFamily){d.canTransform=(this.fontFamily.match(/Osaka-Mono/))}this.wrapCss="";this.wrapCss+="text-align:left;";this.wrapCss+="padding:0;";this.wrapCss+="font-size:"+this.fontSize+"px;";this.wrapCss+="width:"+this.width+"px;";this.wrapCss+="height:"+this.height+"px;";this.wrapCss+="overflow:hidden;";this.wrapCss+="white-space:nowrap;";if(this.isV){this.wrapCss+="border-collapse:collapse;"}else{this.wrapCss+="line-height:1.8em;";this.wrapCss+="letter-spacing:0;"}if(typeof this.fontFamily=="undefined"){this.wrapCss+="font-family:monospace;"}else{if(this.fontFamily==""){this.wrapCss+="font-family:monospace;"}else{this.wrapCss+="font-family:"+this.fontFamily+", monospace;"}}};k.prototype.setHeight=function(n){this.height=n};k.prototype.setWidth=function(n){this.width=n};k.prototype.setCharImgRoot=function(n){this.charImgRoot=n};k.prototype.setCharImgColor=function(n){var o=n.toLowerCase().replace(/#/g,"");if(o=="white"||o=="fff"||o=="ffffff"){this.charImgColor="white"}else{this.charImgColor="black"}};k.prototype.setDirection=function(n){this.direction=n};k.prototype.getDirection=function(){return this.direction};k.prototype.setFontFamily=function(n){this.fontFamily=n};k.prototype.setFontSize=function(n){this.fontSize=n};k.prototype.setLineHeightRate=function(n){this.lineHeightRate=n};k.prototype.setLetterSpacingRate=function(n){this.letterSpacingRate=n};function c(n,o,p){this.buffer=n;this.length=o;this.isEOF=p;this.seekPos=0}c.prototype.getchar=function(){if(this.seekPos<this.buffer.length){var n=this.buffer.substring(this.seekPos,this.seekPos+1);this.seekPos++;return n}else{throw"BufferEnd"}};c.prototype.lookNextChar=function(){if(this.seekPos<this.buffer.length){return this.buffer.substring(this.seekPos,this.seekPos+1)}return""};c.prototype.stepSeekPos=function(){if(this.seekPos<this.buffer.length){this.seekPos++}};c.prototype.getTag=function(){var n="<";while(true){var o=this.getchar();n+=o;if(o==">"){return n}}return""};c.prototype.skipCRLF=function(){var p=this.seekPos;var o=this.lookNextChar();if(o=="\n"){this.seekPos++;return this.seekPos}else{if(o=="\r"){this.seekPos++;var n=this.lookNextChar();if(n=="\n"){this.seekPos++;return this.seekPos}}}return p};c.prototype.setBuffer=function(o,n){this.buffer=o;this.length=(typeof n!="undefined")?n:o.length;this.isEOF=true};c.prototype.addBuffer=function(n){if(!this.isEOF){this.buffer+=n;if(this.buffer.length>=this.length){this.isEOF=true}}};c.prototype.setEOF=function(n){this.isEOF=n};c.prototype.getEOF=function(){return this.isEOF};function b(n){this.kanji="";this.yomi="";this.seekPos=0;this.rubyStartPos=n;this.ready=false}b.prototype.addKanji=function(n){this.kanji+=n};b.prototype.addYomi=function(n){this.yomi+=n};b.prototype.setReady=function(){this.ready=true};b.prototype.isReady=function(){return this.ready};b.prototype.getchar=function(){if(this.seekPos<this.kanji.length){var n=this.kanji.substring(this.seekPos,this.seekPos+1);this.seekPos++;return n}else{throw"RubyBufferEnd"}};var m={tagHook:{},enableTagHook:function(n){return(typeof this.tagHook[n]!="undefined")},addTagHook:function(n,o){this.tagHook[n]=o},getTagHook:function(n){return this.tagHook[n]}};function f(n,o){this.layout=n;this.seekCharCount=0;this.seekTable=[{spos:0,cpos:0}];this.seekWidth=0;this.seekHeight=0;this.seekLineCharCount=0;this.lineBuff="";this.lineSave="";this.resumePos=-1;this.blockBuff="";this.tagStack=[];this.rubyStack=[];this.pageCache=[];this.boutenStack=[];this.boutenCount=0;this.bouten=false;this.indentCount=0;this.rubyStream=null;this.packStr="";this.textStream=o;this.isResuming=false;this.cacheAble=true;this.fontScale=1;this.lineScale=1;this.bgColor="";this.fontStyle="";this.isImgChar=false;this.isHankaku=false;this.imgBuff=[];this.curImgWidth=0;this.imgIndentCount=0;this.blockIndentCount=0;this.halfWordBreak=false}f.prototype.activateTag=function(n,o){var q=["ruby","rp","rb","rt","pack","script","object"];for(var p=0;p<q.length;p++){if(n==q[p]){this[n]=o;return}}};f.prototype.isActiveTag=function(n){if(typeof this[n]=="undefined"){return false}return this[n]};f.prototype.getTextStream=function(){return this.textStream};f.prototype.tagAttr=function(n){var o="";for(prop in n){o+=prop+"='"+n[prop]+"' "}return o};f.prototype.inlineCss=function(n){var o="";for(prop in n){o+=prop+":"+n[prop]+";"}return o};f.prototype.tagStart=function(o,n,p){return"<"+o+" "+this.tagAttr(n)+(p?" />":" >")};f.prototype.charToImg=function(n){switch(n){case"「":case"｢":n="kakko1.gif";break;case"」":case"｣":n="kakko2.gif";break;case"『":n="kakko3.gif";break;case"』":n="kakko4.gif";break;case"（":case"(":case"{":n="kakko5.gif";break;case"）":case"}":case")":n="kakko6.gif";break;case"＜":case"<":case"〈":n="kakko7.gif";break;case"＞":case">":case"〉":n="kakko8.gif";break;case"《":case"≪":n="kakko9.gif";break;case"》":case"≫":n="kakko10.gif";break;case"［":case"[":case"〔":n="kakko13.gif";break;case"］":case"]":case"〕":n="kakko14.gif";break;case"【":n="kakko17.gif";break;case"】":n="kakko18.gif";break;case"｡":case"。":n="kuten.gif";break;case"．":case".":n="kuten2.gif";break;case"､":case"、":case",":case"，":n="touten.gif";break;case"～":case"〜":n="kara.gif";break;case"…":n="mmm.gif";break;case"：":case":":n="tenten.gif";break;case"‥":n="mm.gif";break;case"＝":case"=":n="equal.gif";break;case"―":n="dash.gif";break;case"ー":case"－":case"━":n="｜";break;case"—":case"-":case"‐":case"─":case"−":case"_":case"ｰ":n="｜";break;case"→":case"⇒":n="↓";break;case"←":n="↑";break;case"!":n="！";break;case"?":n="？";break;case"･":n="・";break;case"+":n="＋";break;case"@":n="＠";break;case"#":n="＃";break;case"\\":n="￥";break;default:break}return n};f.prototype.makeCharInner=function(p){var o=this.charToImg(p);if(o.match(/\.gif/)){this.isImgChar=true;var n=(this.layout.charImgColor=="white")?"w@"+o:o;if(typeof this.layout.charImgMap[n]!="undefined"){return this.makeCharImgTag(this.layout.charImgMap[n])}}if(o==p||o.length==1){this.isImgChar=false;return o}this.isImgChar=true;if(this.layout.charImgColor=="white"){o="w_"+o}return this.makeCharImgTag(l.concat(this.layout.charImgRoot,o))};f.prototype.makeCharImgTag=function(r){var q=Math.floor(this.layout.fontSize*this.fontScale);var o=q;var p={"vertical-align":"top",width:q+"px",height:o+"px","line-height":o+"px",margin:"0",padding:"0","border-width":"0"};var n={src:r,style:this.inlineCss(p)};return this.tagStart("img",n,true)};f.prototype.getBoutenStr=function(n){switch(n){case"bt-disc":return"・";case"bt-accent":return"ヽ";case"bt-circle":return"。";case"bt-dot":return"・"}return"・"};f.prototype.parseAttr=function(r){var q=r.split(/[\s\t　]+/);var o={};var n=this;for(var p=0;p<q.length;p++){(function(s,u){if(s.match(/([^=]+)=(.+)/)){var t=RegExp.$1;var w=n.cutQuote(RegExp.$2);o[t]=w}})(q[p],p)}return o};f.prototype.cutQuote=function(n){return n.replace(/\"/g,"").replace(/\'/g,"")};f.prototype.unscript=function(n){return n.replace(/script\:/gi,"")};f.prototype.startBgColor=function(){if(this.layout.isV){var q=Math.floor(this.layout.yohakuHeight*this.lineScale);var p=Math.floor(q/3);var o=Math.floor(this.layout.baseLineHeight*this.lineScale);var n={"text-align":"center",padding:p+"px 0",width:o+"px","background-color":this.bgColor};return this.tagStart("div",{style:this.inlineCss(n)},false)}else{var n={"padding-top":"0.3em","padding-left":"0.3em","vertical-align":"middle","background-color":this.bgColor};return this.tagStart("span",{style:this.inlineCss(n)},false)}};f.prototype.endBgColor=function(){if(this.layout.isV){return"</div>"}return"</span>"};f.prototype.makeLineTd=function(){if(this.boutenCount>0){this.boutenStack.push({startPos:this.boutenStartPos,count:this.boutenCount,str:this.boutenStr});this.boutenCount=0;this.boutenStartPos=0}var r=Math.floor(this.layout.fontSize*this.lineScale);var q=Math.floor(this.layout.yohakuHeight*this.lineScale);var n=r+q;var o={"font-size":this.layout.fontSize+"px",margin:"0",padding:"0","text-align":(this.lineScale>1)?"center":"left","line-height":this.layout.letterHeight+"px","vertical-align":"top",width:r+"px"};var p={margin:"0",padding:"0","text-align":"left",width:q+"px","vertical-align":"top"};return(this.tagStart("td",{style:this.inlineCss(o)},false)+this.lineBuff+"</td>"+this.tagStart("td",{style:this.inlineCss(p)},false)+this.makeRubyLine()+this.makeBoutenLine()+"</td>")};f.prototype.makeRubyLine=function(){var p="";var o=this;var r={position:"absolute","font-size":Math.floor(this.layout.rubyFontSize*this.lineScale)+"px","line-height":"1.14em"};var n=this.inlineCss(r);var s=this.indentCount*this.layout.letterHeight;for(var q=0;q<this.rubyStack.length;q++){(function(v,t){var w=n+"margin-top:"+Math.floor(s+t.startPos)+"px;";p+=o.tagStart("div",{style:w},false);for(var u=0;u<t.yomi.length;u++){(function(x,z){p+=o.makeCharInner(z)+"<br />"})(u,t.yomi.substring(u,u+1))}p+="</div>"})(q,this.rubyStack[q])}this.rubyStack=[];return p};f.prototype.makeLineH=function(){var n="";if(this.rubyStack.length>0){n+=this.makeRubyLineH()}n+="<div>";n+=this.lineBuff+"<br />";if(this.fontStyle!=""){n+="</span>"}if(this.bgColor!=""){n+=this.endBgColor()}n+="</div>";return n};f.prototype.makeRubyLineH=function(){var o="";var n=this;var r=this.indentCount*this.layout.letterHeight;var s=Math.floor(this.layout.rubyFontSize*this.lineScale);var q={"font-size":s+"px",margin:"0",padding:"0","line-height":s+"px"};o+=this.tagStart("div",{style:this.inlineCss(q)},false);for(var p=0;p<this.rubyStack.length;p++){(function(v,t){var w="position:absolute; margin-top:-0.3em; margin-left:"+Math.floor(r+t.startPos)+"px;";o+=n.tagStart("span",{style:w},false);for(var u=0;u<t.yomi.length;u++){(function(x,z){o+=z})(u,t.yomi.substring(u,u+1))}o+="</span>"})(p,this.rubyStack[p])}this.rubyStack=[];o+="</div>";return o};f.prototype.makeBoutenLine=function(){var p="";var o=this;var r={position:"absolute","margin-left":"-0.35em"};var n=this.inlineCss(r);for(var q=0;q<this.boutenStack.length;q++){(function(t){while(t.count>0){if(t.str=="・"){var s=o.layout.fontSize}else{if(t.str=="ヽ"){var s=Math.floor(o.layout.fontSize*70/100)}}var u=n+"; font-size:"+s+"px; margin-top:"+t.startPos+"px;";p+=o.tagStart("div",{style:u},false);p+=t.str;p+="</div>";t.startPos+=o.layout.letterHeight;t.count--}})(this.boutenStack[q])}this.boutenStack=[];return p};f.prototype.normalIndent=function(p){this.isHankaku=false;if(this.lineScale<=1){if(p.match(/[a-z0-9]/i)){this.isHankaku=true;var n={"margin-left":"0.2em","line-height":"1em"};var o=this.inlineCss(n);return(this.tagStart("span",{style:o},false)+p+"</span><br />")}}return this.makeCharInner(p)+"<br />"};f.prototype.toBold=function(n){return("<b>"+n+"</b>")};f.prototype.toStyle=function(n){return(function(o){return("<span style='"+n+"'>"+o+"</span>")})};f.prototype.toLink=function(n){return(function(o){return("<a href='"+n+"'>"+o+"</a>")})};f.prototype.toLink2=function(n){return(function(o){return("<a target='_blank' href='"+n+"'>"+o+"</a>")})};f.prototype.isHeadNg=function(o){var n=["？","】","，",",","》","。","、","・","｣","」","』","）","＞","〉","≫","]","〕","]","］","！","!",") ","々","ゝ","ー","－"];for(i=0;i<n.length;i++){if(o==n[i]){return true}}return false};f.prototype.isTailNg=function(o){var n=["【","《","「","『","（","［","[","〔","＜","≪","(","〈"];for(i=0;i<n.length;i++){if(o==n[i]){return true}}return false};f.prototype.applyTagStack=function(q,p){var n=p?this.normalIndent(q):q;for(i=this.tagStack.length-1;i>=0;i--){var o=this.tagStack[i];n=o(n)}return n};f.prototype.isValidPageRange=function(n){return(0<=n&&n<this.seekTable.length)};f.prototype.setSeekPage=function(n){if(this.isValidPageRange(n)){this.textStream.seekPos=this.seekTable[n].spos;this.seekWidth=0;this.seekHeight=0;this.seekLineCharCount=0;if(n==0){this.tagStack=[]}}};f.prototype.getPageSeekPos=function(n){if(this.isValidPageRange(n)){return this.seekTable[n]}return 0};f.prototype.getSeekPercent=function(n){if(n<this.seekTable.length-1){return Math.floor(100*this.seekTable[n+1].spos/this.textStream.length)}return 100};f.prototype.getPageSourceText=function(n){if(n<this.seekTable.length){var p=this.seekTable[n].spos;if(n+1<this.seekTable.length){var o=this.seekTable[n+1].spos;return this.textStream.buffer.substring(p,o)}}return""};f.prototype.makeRestSpaceTd=function(){var o=this.layout.width-this.seekWidth;var n="";if(o>0){n="<td style='display:block; width:"+o+"px; height:"+this.layout.height+"'></td>\n"}return n};f.prototype.getPageSeekPos=function(n){if(this.isValidPageRange(n)){return this.seekTable[n]}return{spos:0,cpos:0}};f.prototype.saveSeekState=function(n,o){if(this.isValidPageRange(n)){this.seekTable[n]=o}else{this.seekTable.push(o)}};f.prototype.fixH=function(n){if(n=="―"){return"<span style='margin-top:-0.2em; float:right'>"+n+"</span>"}return n};f.prototype.fixW=function(n){if(n=="―"||n=="…"){return"<span style='margin-left:-0.24em'>"+n+"</span>"}return n};f.prototype.hasNextPage=function(){return(this.textStream.seekPos<this.textStream.length)};f.prototype.addCache=function(o,n){this.pageCache[o]=n};f.prototype.clearCache=function(){this.pageCache=[];this.tagStack=[]};f.prototype.reset=function(){this.clearCache();this.textStream.seekPos=0};f.prototype.getLetterCount=function(n){if(escape(n).charAt(1)=="u"){return 1}else{if(!this.layout.isV){return 0.5}else{return(n==" ")?1:d.canTransform?0.5:1}}};f.prototype.addIndent=function(o){var p=(this.layout.isV)?"　<br />":"　";for(var n=0;n<o;n++){this.lineBuff+=p}};f.prototype.getLayout=function(){return this.layout};f.prototype.setLayout=function(n){this.layout=n;this.layout.initialize()};f.prototype.getPageLayout=function(p,n){var r="<"+this.layout.wrapTag+" class='"+this.layout.textLayerClassName+"' style='"+this.layout.wrapCss+"'>";var q="</"+this.layout.wrapTag+">";var o=(n!="")?r+n+q:"";this.addCache(p,o);return o};f.prototype.outputPage=function(n){if(this.isResuming){this.isResuming=false;return this.parsePage(n)}else{if(typeof this.pageCache[n]!="undefined"){this.setSeekPage(n+1);return this.pageCache[n]}else{this.setSeekPage(n);return this.parsePage(n)}}};f.prototype.onOverFlowPage=function(n,p){if(p){if(this.layout.directionH=="rl"){this.blockBuff=this.makeRestSpaceTd()+this.blockBuff}else{this.blockBuff=this.blockBuff+this.makeRestSpaceTd()}}var o=(p)?"<tr>"+this.blockBuff+"</tr>":this.blockBuff;this.saveSeekState(n+1,{spos:this.textStream.seekPos,cpos:this.seekCharCount});this.blockBuff="";this.lineBuff="";if(this.bgColor!=""){this.lineBuff+=this.startBgColor()}this.lineScale=this.fontScale;if(p){this.seekWidth=0}else{this.seekHeight=0}this.seekLineCharCount=0;return this.getPageLayout(n,o)};f.prototype.onBufferEnd=function(n,o){if(this.textStream.isEOF){if(this.lineBuff!=""){this.pushLine(n,o)}return this.onOverFlowPage(n,o)}else{this.isResuming=true;if(this.resumePos>=0){this.textStream.seekPos=this.resumePos;this.lineBuff=this.lineSave}throw"BufferEnd"}};f.prototype.onRubyBufferEnd=function(n,o){delete this.rubyStream;this.rubyStream=null};f.prototype.pushLineToBlockV=function(n){if(this.layout.directionH=="rl"){this.blockBuff=n+this.blockBuff}else{this.blockBuff+=n}};f.prototype.pushLine=function(n,o){if(this.blockBuff!=""||this.lineBuff!=""){if(o){if(this.halfBuff){this.lineBuff+=this.outputHalfWord();if(this.getLetterCount(this.textStream.lookNextChar())<1){this.halfWordBreak=true}}this.pushLineToBlockV(this.makeLineTd())}else{this.blockBuff+=this.makeLineH()}this.lineBuff="";if(this.fontStyle!=""){this.lineBuff+=fontStyle}if(this.bgColor!=""){this.lineBuff=this.startBgColor()}if(o){this.seekWidth+=Math.floor(this.layout.baseLineHeight*this.lineScale);this.seekHeight=0}else{this.seekHeight+=Math.floor(this.layout.baseLineHeight*this.lineScale);this.seekWidth=0}this.seekLineCharCount=0;this.lineScale=this.fontScale}};f.prototype.checkOverflow=function(n){if(n){return(this.seekWidth+Math.floor(this.layout.fontSize*this.lineScale)>this.layout.width)}return(this.seekHeight+Math.floor((this.layout.fontSize+this.layout.rubyFontSize)*this.lineScale)>this.layout.height)};f.prototype.parseEndPage=function(o,q,r,n,p){if(this.lineBuff!=""){this.pushLine(o,q)}if(this.recursiveParser){this.textStream.seekPos=this.resumePos}throw"OverflowPage"};f.prototype.adjustSize=function(p,s,r,n){var o=p;var q=s;if(p>r){o=r;q-=Math.floor((s/p)*(p-r))}if(s>n){q=n;o-=Math.floor((p/s)*(s-n))}return{width:o,height:q}};f.prototype.parseObjectStart=function(p,s,u,o,q){var r=parseInt(o.width);var n=parseInt(o.height);var t=(typeof o.align!="undefined")?o.align:"none";this.objFigure={src:u,align:t,width:r,height:n,drawWidth:r,drawHeight:n}};f.prototype.parseObjectBody=function(o,q,r,n,p){if(this.objFigure){this.objFigure.src+=r}};f.prototype.parseObjectEnd=function(o,q,r,n,p){this.objFigure.src+=r;this.pushFigure(o,q,"object",this.objFigure)};f.prototype.parseImg=function(o,p,y,v,s){var n=this.unscript(v.src);var q=(typeof v.width!="undefined")?parseInt(v.width):200;var x=(typeof v.height!="undefined")?parseInt(v.height):300;var u=(typeof v.align!="undefined")?v.align:"none";var r=this.layout.width-this.seekWidth;var w=this.layout.height-this.seekHeight;var t=this.adjustSize(q,x,r,w);this.pushFigure(o,p,"img",{src:n,align:u,width:q,height:x,drawWidth:t.width,drawHeight:t.height})};f.prototype.pushFigure=function(n,o,s,q){if(this.lineBuff!=""){this.pushLine(n,o);if(this.checkOverflow(o)){this.textStream.seekPos=this.resumePos;throw"OverflowPage"}}if(this.recursiveParser){if(this.lineBuff!=""){this.pushLine(n,o)}this.textStream.seekPos=this.resumePos;throw"OverflowPage"}if((o&&q.width>this.layout.width)||(!o&&q.height>this.layout.height)){return}if((o&&this.seekWidth+q.drawWidth+this.layout.yohakuHeight>this.layout.width)||(!o&&this.seekHeight+q.drawHeight+this.layout.yohakuHeight>this.layout.height)){this.textStream.seekPos=this.resumePos;throw"OverflowPage"}if((q.drawWidth!=q.width||q.drawHeight!=q.height)&&(q.drawWidth*2<q.width||q.drawHeight*2<q.height)){this.textStream.seekPos=this.resumePos;throw"OverflowPage"}if(o){var y=this.layout.height-q.drawHeight-this.layout.fontSize}else{var y=this.layout.width-q.drawWidth-this.layout.fontSize}var t="";if(o){if(!this.textStream.isEOF||q.align=="none"||y<=0||y*2<this.layout.height){if(s=="img"){var u=this.tagStart("img",{src:q.src,width:q.drawWidth,height:q.drawHeight},true)}else{if(s=="object"){var u=q.src}}}else{if(q.align=="top"||q.align=="left"){var p="padding:0; margin-bottom:"+this.layout.fontSize+"px;"}else{if(q.align=="bottom"||q.align=="right"){var p="padding:0; margin-top:0;"}}if(s=="img"){var u=this.tagStart("img",{src:q.src,width:q.drawWidth,height:q.drawHeight,style:p},true)}else{if(s=="object"){var u=this.tagStart("div",{style:p},false)+q.src+"</div>"}}var r=new f(new k({width:q.drawWidth,height:y,fontSize:this.layout.fontSize,direction:this.layout.direction,charImgRoot:this.layout.charImgRoot,charImgMap:this.layout.charImgMap,charImgColor:this.layout.charImgColor}),this.textStream);r.recursiveParser=true;if(this.layout.fontFamily){r.layout.fontFamily=this.layout.fontFamily;r.layout.initialize()}t=r.parsePage(0);delete r}var v={"vertical-align":"top","padding-right":this.layout.yohakuHeight+"px"};var x=(q.align=="top"||q.align=="left")?u+t:t+u;this.blockBuff=this.tagStart("td",{style:this.inlineCss(v)},false)+x+"</td>"+this.blockBuff;this.seekWidth+=q.drawWidth+this.layout.yohakuHeight}else{if(!this.textStream.isEOF||q.align=="none"||y<=0||y*2<this.layout.width){if(s=="img"){var u=this.tagStart("img",{src:q.src,width:q.drawWidth,height:q.drawHeight},true)}else{if(s=="object"){var u=q.src}}this.blockBuff+=u+"<br />";this.seekHeight+=q.drawHeight+this.layout.yohakuHeight}else{if(s=="img"){var u=this.tagStart("img",{src:q.src,width:q.drawWidth,height:q.drawHeight},true)}else{if(s=="object"){var u=q.src}}var r=new f(new k({width:y,height:q.drawHeight,fontSize:this.layout.fontSize,direction:"horizontal",charImgRoot:this.layout.charImgRoot,charImgMap:this.layout.charImgMap,charImgColor:this.layout.charImgColor}),this.textStream);r.recursiveParser=true;if(this.layout.fontFamily){r.layout.fontFamily=this.layout.fontFamily;r.layout.initialize()}t=r.parsePage(0);delete r;if(q.align=="top"||q.align=="left"){var w="<div style='float:left; width:"+(q.drawWidth+this.layout.fontSize)+"px;'>"+u+"</div>";var z="<div style='float:left; width:"+y+"px;'>"+t+"</div>"}else{if(q.align=="bottom"||q.align=="right"){var w="<div style='float:left; width:"+y+"px;'>"+t+"</div>";var z="<div style='float:left; width:"+(q.drawWidth+this.layout.fontSize)+"px;'>"+u+"</div>"}}this.blockBuff+=("<div style='width:"+this.layout.width+"px;'>"+w+z+"<div style='clear:left;line-height:0px;font-size:0px;'></div></div>");this.seekHeight+=q.drawHeight+this.layout.yohakuHeight}}};f.prototype.parseLinkStart=function(o,r,t,n,q){var p=this.unscript(n.href);if(typeof n.target!="undefined"){var s=(n.target=="_blank")}else{if(q=="a2"){var s=true}else{var s=false}}if(r){if(s){this.tagStack.push(this.toLink2(p))}else{this.tagStack.push(this.toLink(p))}}else{if(q=="a"){this.lineBuff+=t}else{this.lineBuff+="<a target='_blank' href='"+p+"'>"}}};f.prototype.parseLinkEnd=function(o,q,r,n,p){if(q){this.tagStack.pop()}else{if(p=="/a2"){this.lineBuff+="</a>"}else{this.lineBuff+=r}}};f.prototype.parseBoldStart=function(o,q,r,n,p){if(q){this.tagStack.push(this.toBold)}else{this.lineBuff+=r}};f.prototype.parseBoldEnd=function(o,q,r,n,p){if(q){this.tagStack.pop()}else{this.lineBuff+=r}};f.prototype.parseFontStart=function(o,s,t,n,q){var p={};this.fontScale=(typeof n.scale!="undefined")?parseFloat(n.scale):1;if(this.fontScale<1||this.fontScale>1){p["font-size"]=this.fontScale+"em";if(s){p["line-height"]="1.1em"}}if(this.fontScale>this.lineScale){this.lineScale=this.fontScale}if(typeof n.color!="undefined"){p.color=n.color}if(typeof n.fontfamily!="undefined"){p["font-family"]=n.fontfamily}this.bgColor=(typeof n.bgcolor!="undefined")?n.bgcolor:"";if(this.bgColor!=""){this.lineBuff+=this.startBgColor()}var r=this.inlineCss(p);if(r!=""){r+="vertical-align:baseline;";if(s){this.tagStack.push(this.toStyle(r))}else{this.fontStyle=this.tagStart("span",{style:r},false);this.lineBuff+=this.fontStyle}}};f.prototype.parseFontEnd=function(o,q,r,n,p){this.fontScale=1;if(this.seekLineCharCount==0){this.lineScale=1}if(q){if(this.bgColor!=""){this.lineBuff+=this.endBgColor();this.bgColor=""}this.tagStack.pop()}else{this.fontStyle="";this.lineBuff+="</span>";if(this.bgColor!=""){this.lineBuff+=this.endBgColor();this.bgColor=""}}};f.prototype.parseBoutenStart=function(o,q,r,n,p){this.bouten=true;this.boutenStartPos=this.seekHeight;if(d.isIE){this.boutenStartPos+=Math.floor(this.layout.baseLetterSpacing*this.fontScale)}this.boutenStr=this.getBoutenStr(p)};f.prototype.parseBoutenEnd=function(o,q,r,n,p){this.bouten=false;this.boutenStack.push({startPos:this.boutenStartPos,count:this.boutenCount,str:this.boutenStr});this.boutenCount=0};f.prototype.parsePackStart=function(o,q,r,n,p){if(q){this.packStr=""}};f.prototype.parseRubyStart=function(o,q,r,n,p){if(q){this.rubyStream=new b(this.seekHeight)}else{this.rubyStream=new b(this.seekWidth)}};f.prototype.parseRubyEnd=function(o,q,r,n,p){this.rubyStack.push({yomi:this.rubyStream.yomi,startPos:this.rubyStream.rubyStartPos});this.rubyStream.setReady()};f.prototype.parseBlockquoteStart=function(o,q,r,n,p){this.blockIndentCount=(typeof n.indent!="undefined")?parseInt(n.indent):2;this.indentCount+=this.blockIndentCount;if(this.lineCount<=this.indentCount*2){this.activateTag("blockquote",false)}this.layout.lineCount-=this.blockIndentCount*2};f.prototype.parseBlockquoteEnd=function(o,q,r,n,p){this.indentCount-=this.blockIndentCount;this.layout.lineCount+=this.blockIndentCount*2;this.blockIndentCount=0};f.prototype.parseTagHook=function(p,r,s,o,q,n){if(m.enableTagHook(q)){m.getTagHook(q).apply(this,[p,r,s,o,q])}};f.prototype.parseTag=function(o,s){var t=this.textStream.getTag();var q=t.replace("<","").replace(">","").replace("/>","");var n=this.parseAttr(q);var p=q.split(/[\s\t]+/)[0].toLowerCase();var r=(p.substring(0,1)=="/");this.activateTag(p.replace("/",""),!r);switch(p){case"end-page":this.parseEndPage(o,s,t,n,p);break;case"img":this.parseImg(o,s,t,n,p);break;case"a":case"a2":this.parseLinkStart(o,s,t,n,p);break;case"/a":case"/a2":this.parseLinkEnd(o,s,t,n,p);break;case"b":case"strong":this.parseBoldStart(o,s,t,n,p);break;case"/b":case"/strong":this.parseBoldEnd(o,s,t,n,p);break;case"font":this.parseFontStart(o,s,t,n,p);break;case"/font":this.parseFontEnd(o,s,t,n,p);break;case"bt-disc":case"bt-accent":case"bt-circle":case"bt-dot":this.parseBoutenStart(o,s,t,n,p);break;case"/bt-disc":case"/bt-accent":case"/bt-circle":case"/bt-dot":this.parseBoutenEnd(o,s,t,n,p);break;case"pack":this.parsePackStart(o,s,t,n,p);break;case"ruby":this.parseRubyStart(o,s,t,n,p);break;case"/ruby":this.parseRubyEnd(o,s,t,n,p);break;case"blockquote":this.parseBlockquoteStart(o,s,t,n,p);break;case"/blockquote":this.parseBlockquoteEnd(o,s,t,n,p);break;case"object":this.parseObjectStart(o,s,t,n,p);break;case"/object":this.parseObjectEnd(o,s,t,n,p);break;case"embed":case"/embed":case"param":case"/param":this.parseObjectBody(o,s,t,n,p);break;default:this.parseTagHook(o,s,t,n,p);break}};f.prototype.checkTailNg=function(n,p){var o=this.textStream.lookNextChar();if(this.isTailNg(o)){this.pushLine(n,p);this.textStream.skipCRLF()}};f.prototype.checkHeadNg=function(n,q){var p=this.textStream.lookNextChar();if(this.isHeadNg(p)){this.textStream.stepSeekPos();this.seekCharCount++;if(this.bouten){this.boutenCount++}if(q){this.lineBuff+=this.applyTagStack(p,true)}else{this.lineBuff+=this.fixW(p)}var o=this.textStream.lookNextChar();if(this.isHeadNg(o)){this.textStream.stepSeekPos();this.seekCharCount++;if(this.bouten){this.boutenCount++}this.lineBuff+=this.applyTagStack(o,true)}}this.pushLine(n,q);this.textStream.skipCRLF()};f.prototype.outputHalfWord=function(){if(this.halfBuff.lenght==1){var n=this.applyTagStack(this.halfBuff,true)}else{if(this.halfBuff.length==2&&!this.halfWordBreak&&(this.halfBuff.match(/\d+/)||this.halfBuff.match(/[!\?]+/))){var n=this.applyTagStack(this.halfBuff,true)}else{if(d.isIE){var p=this.inlineCss({"writing-mode":"tb-rl",width:this.layout.fontSize+"px"});var n="<div style='"+p+"'>"+this.applyTagStack(this.halfBuff,false)+"</div>"}else{var o=this.fontScale*this.layout.fontSize/2;var q=Math.max(0,Math.floor((this.halfBuff.length-2)*o));var p=this.inlineCss({"-webkit-transform":"rotate(90deg)","-webkit-transform-origin":"50% 50%","-moz-transform":"rotate(90deg)","-moz-transform-origin":"50% 50%","margin-bottom":q+"px",width:this.layout.fontSize+"px"});var n="<div style='"+p+"'>"+this.applyTagStack(this.halfBuff,false)+"</div>"}}}delete this.halfBuff;this.halfBuff=null;this.halfWordBreak=false;return n};f.prototype.pushHalfChar=function(o){if(this.halfBuff){this.halfBuff+=o}else{this.halfBuff=o}var n=this.textStream.lookNextChar();if(this.getLetterCount(n)>=1||n=="<"||n==" "||n=="　"||n=="\t"||n=="\r"||n=="\n"){this.lineBuff+=this.outputHalfWord()}};f.prototype.pushChar=function(o,r,p){var s=this.getLetterCount(p);var q=s*this.fontScale;if(this.seekLineCharCount==0&&this.indentCount>0){this.addIndent(this.indentCount)}if(r){if(s<1&&d.canTransform){this.pushHalfChar(p)}else{this.lineBuff+=this.applyTagStack(p,true)}if(this.isImgChar){this.seekHeight+=Math.floor(q*this.layout.fontSize)}else{if(this.isHankaku){this.seekHeight+=Math.floor(q*this.layout.fontSize)}else{this.seekHeight+=Math.floor(q*this.layout.letterHeight)}}}else{this.lineBuff+=this.fixW(p);this.seekWidth+=Math.floor(q*this.layout.fontSize)}this.seekLineCharCount+=q;this.seekCharCount++;if(this.bouten){this.boutenCount++}var n=this.layout.lineCount-this.seekLineCharCount;if(1<=n&&n<=1.5){this.checkTailNg(o,r)}else{if(n<1){this.checkHeadNg(o,r)}}};f.prototype.parsePage=function(n){var r=this.layout.isV;this.lineSave="";while(true){try{this.resumePos=-1;var q=this.textStream.seekPos;if(!this.pack&&this.packStr!=""){var o=this.packStr;this.packStr=""}else{if(this.rubyStream&&this.rubyStream.isReady()){var o=this.rubyStream.getchar()}else{var o=this.textStream.getchar()}}if(o=="\r"){}else{if(o=="\n"){this.pushLine(n,r)}else{if(o=="<"){this.lineSave=this.lineBuff;this.resumePos=q;this.parseTag(n,r)}else{if(this.isActiveTag("pack")){this.packStr+=o}else{if(this.isActiveTag("ruby")){if(this.isActiveTag("rt")){this.rubyStream.addYomi(o)}else{if(this.isActiveTag("rb")){this.rubyStream.addKanji(o)}}}else{if(this.isActiveTag("script")){}else{this.pushChar(n,r,o)}}}}}}if(this.checkOverflow(r)){throw"OverflowPage"}}catch(p){if(p=="RubyBufferEnd"){this.onRubyBufferEnd(n,r)}else{if(p=="OverflowPage"){return this.onOverFlowPage(n,r)}else{if(p=="BufferEnd"){return this.onBufferEnd(n,r)}}}}}};var g={parse:function(r){var q=r.split(/[\s\t]/);var o={direction:"vertical",fontSize:16,width:400,height:300,order:0,charImgColor:"black",isSinglePaging:false};for(var p=0;p<q.length;p++){var n=q[p];if(n=="lp-vertical"||n=="lp-vertical-rl"){o.direction="vertical"}else{if(n=="lp-vertical-lr"){o.direction="vertical-lr"}else{if(n=="lp-horizontal"){o.direction="horizontal"}else{if(n.match(/span-([0-9]+)/)){o.width=parseInt(RegExp.$1)*40-10}else{if(n.match(/lp-width-([0-9]+)/)){o.width=parseInt(RegExp.$1)}else{if(n.match(/lp-height-([0-9]+)/)){o.height=parseInt(RegExp.$1)}else{if(n.match(/lp-font-size-([0-9]+)/)){o.fontSize=parseInt(RegExp.$1)}else{if(n.match(/lp-order-([0-9]+)/)){o.order=parseInt(RegExp.$1)}else{if(n.match(/lp-char-img-white/)){o.charImgColor="white"}else{if(n.match(/lp-single-paging/)){o.isSinglePaging=true}}}}}}}}}}}return o}};function a(u,r,q){this.grids=r.sort(function(w,v){return(w.order-v.order)});this.head=this.grids[0];var t=this.head.node.innerHTML;if(d.isIE||!q.noBR){t=t.replace(/<br \/>/gi,"\n").replace(/<br>/gi,"\n")}this.fontFamily=q.fontFamily;this.onSeek=q.onSeek;this.onComplete=q.onComplete;this.charImgRoot=q.charImgRoot;this.groupName=u;this.gridIndex=0;this.parser=new f(new k({direction:this.head.direction,width:this.head.width,height:this.head.height,fontSize:this.head.fontSize,fontFamily:this.fontFamily,kinsokuCharCount:1,letterSpacingRate:0.1,charImgRoot:this.charImgRoot,charImgColor:this.head.charImgColor}),new c(t,t.length,true));if(this.head.isSinglePaging){if(document.getElementById(u+"-pager")){var s=document.getElementById(u+"-pager");var o=s.getElementsByTagName("a");var n=this;for(var p=0;p<o.length;p++){(function(v){if(v.className.match(/next/)){v.onclick=function(){if(n.parser.hasNextPage()){n.gridIndex++;n.render(n.gridIndex)}}}else{if(v.className.match(/prev/)){v.onclick=function(){if(n.gridIndex>0){n.gridIndex--;n.render(n.gridIndex)}}}}})(o[p])}}}}a.prototype.setGridLayout=function(o){var n=this.parser.layout;n.setDirection(o.direction);n.setWidth(o.width);n.setHeight(o.height);n.setFontSize(o.fontSize);n.setFontFamily(this.fontFamily);n.setCharImgColor(o.charImgColor);n.setCharImgRoot(this.charImgRoot);n.initialize()};a.prototype.getGrid=function(n){return(n<this.grids.length)?this.grids[n]:this.grids[this.grids.length-1]};a.prototype.render=function(r){this.gridIndex=r;var p=(this.head.isSinglePaging)?this.head:this.getGrid(r);this.setGridLayout(p);var o=this.parser.outputPage(r);this.onSeek(this.groupName,this.parser.getSeekPercent(r));if(o!=""){if(r<this.grids.length||this.head.isSinglePaging){p.node.innerHTML=o}else{var q=document.createElement("div");q.innerHTML=o;p.node.appendChild(q)}}if(!this.parser.hasNextPage()){this.onComplete(this.groupName);e.setFinish(this.groupName)}else{if(!this.head.isSinglePaging){var n=this;setTimeout(function(){n.render(r+1)},0)}}};var e={setFinish:function(n){this.finishFlag[n]=true;if(this.checkCompleteAll()){this.onCompleteAll()}},checkCompleteAll:function(){for(var n in this.finishFlag){if(!this.finishFlag[n]){return false}}return true},start:function(z,v){var t={filter:"direction",noBR:false,charImgRoot:"/img/char",fontFamily:"Hiragino Sans GB, Hiragino Kaku Gothic Pro, SimSun",onSeek:function(B,A){},onComplete:function(A){},onCompleteAll:function(){}};if(typeof v=="undefined"){v={}}for(var n in t){if(n=="onCompleteAll"){this[n]=(typeof v[n]!="undefined")?v[n]:t[n]}else{v[n]=(typeof v[n]!="undefined")?v[n]:t[n]}}var o=document.getElementsByTagName(z);var s=function(C,D,A){var B=g.parse(A);B.node=C;B.tagGroup=z;return B};var r={};this.finishFlag={};for(var u=0;u<o.length;u++){var q=o[u];var p=false;if(v.filter=="group"){if(q.className.match(/lp-group-([a-zA-Z0-9\-_]+)/)){var y=RegExp.$1;p=true}}else{if(v.filter=="direction"){if(q.className.match(/lp-vertical/)){var y="group-v"+u;p=true}else{if(q.className.match(/lp-horizontal/)){var y="group-h"+u;p=true}}}}if(p){var x=q.className;var w=s(q,y,x);if(typeof r[y]=="undefined"){this.finishFlag[y]=false;r[y]=[w]}else{r[y].push(w)}}}for(var y in r){(new a(y,r[y],v)).render(0)}}};Nehan.Env=d;Nehan.Layout=k;Nehan.TextStream=c;Nehan.StreamParser=f;Nehan.LayoutMapper=e;Nehan.ParserHook=m})();
